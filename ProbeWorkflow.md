# Documentation for `ProbeSnakefile`


## Workflow Overview

This workflow generates a set of oligonucleotide probes for a given list of transcripts. It performs off-target analysis, ensures probes meet biophysical constraints, and attaches the appropriate readout sequences for multiplexed imaging.

```mermaid
graph TD
    A[Transcriptome FASTA] --> B{create_dataset};
    B --> C[Self-Contained Dataset];
    C --> D{Probe Generation};
    E[JSON Codebook] --> D;
    D --> F[Final Probe Files (.parquet)];
    F --> G{assemble_manifest};
    G --> H[manifest.csv];
    G --> I[for_idt.csv];

    classDef input fill:#f9f,stroke:#333;
    classDef process fill:#bbf,stroke:#333;
    classDef intermediate fill:#9cf,stroke:#333;
    classDef final_output fill:#9f9,stroke:#333;

    class A,E input;
    class B,D,G process;
    class C,F intermediate;
    class H,I final_output;
```

---

## Configuration (`config.yaml`)

| Parameter               | Type            | Description                                                                                                                              | Example Value                                       |
| ----------------------- | --------------- | ---------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| `species`               | string          | The species for the dataset (e.g., "human", "mouse").                                                                                    | `"human"`                                           |
| `transcriptome_fasta`   | string          | Path to the input transcriptome FASTA file.                                                                                              | `"path/to/transcriptome.fasta"`                     |
| `codebook`              | string          | Path to the JSON codebook file (generated by the `CodebookSnakefile` workflow).                                                          | `"results/codebooks/n20_on4.json"`                  |
| `transcripts`           | list of strings | A list of the transcript IDs to generate probes for. Must have a 1:1 correspondence with the non-blank keys in the codebook.                | `["ENST...", "ENST..."]`                           |
| `dataset_dir`           | string          | The directory where the self-contained, pre-processed dataset will be stored.                                                            | `"results/dataset"`                                 |
| `probegen_dir`          | string          | The main output directory where all intermediate and final probe generation files will be stored.                                        | `"results/probegen"`                                |

---
Ex:
```
species: "human"
transcriptome_fasta: "path/to/transcriptome.fasta"
codebook: "results/codebooks/n9_on4.json"
transcripts:
  - "ENST..."
  - "ENST..."
dataset_dir: "results/dataset"
probegen_dir: "results/probegen"
```
<!-- Why are transcripts a separate entry in the config for probegen? -->

## Rules

### 1. `create_dataset`

This rule prepares the raw transcriptome FASTA file for the workflow by creating a self-contained dataset directory with necessary indices.

| Type   | Description                                                                  | Path (Example)                | Schema / Format                                                                                                                                                                                                                                 |
| ------ | ---------------------------------------------------------------------------- | ----------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**  | The raw transcriptome sequences.                                             | `path/to/transcriptome.fasta` | **FASTA**: Standard format with headers containing transcript IDs that match the codebook.                                                                                                                                                      |
| **Output** | A sentinel file indicating that the dataset and its indices are complete. | `results/dataset/dataset.json`  | **Directory**: This rule creates a directory containing the FASTA, a Parquet cache of the FASTA (`.parquet`), a Bowtie2 index (`.bt2`), a Jellyfish k-mer count file (`.jf`), and the `dataset.json` sentinel. |
Ex dataset.json: 
```
{
  "species": "human",
  "external_data": {
    "default": {
      "cache_name": "transcriptome.parquet",
      "gtf_name": "annotations.gtf.gz",
      "fasta_name": "transcriptome.fasta",
      "kmer18_name": "transcriptome.jf",
      "bowtie2_index_name": "transcriptome"
    }
  }
}
```

### 2. Probe Generation Rules (`get_candidates`, `screen_probes`, `construct_final_probes`)

These rules are logically distinct but are executed by a single, monolithic script (`probegen/1_run_codebook_generic.py`) in the repository. The script manages the intermediate steps internally based on file existence.

#### **`get_candidates`**
| Type   | Description                                                                                                      | Path (Example)                                                                  | Schema / Format                                                                                                                                                                                                                                                           |
| ------ | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**  | The self-contained dataset with sequences and pre-computed indices.                                              | `results/dataset/`                                                              | **Directory**: Contains FASTA, Parquet, Bowtie2 index, and Jellyfish files.                                                                                                                                                                                               |
| **Input**  | A specific transcript ID for which to generate probes.                                                           | (from `config.yaml`)                                                            | **String**: A valid transcript identifier (e.g., "ENST...").                                                                                                                                                                                                                |
| **Output** | A Parquet file for each transcript containing all potential probe candidates that pass initial filtering. | `results/probegen/output/ENST..._crawled.parquet`                            | **Parquet**: Table with columns: `transcript` (string), `probe` (string), `start` (int), `end` (int), `tm` (float), `gc` (float), `n_offtargets` (int), etc. See `validation.schema.json` for the full schema. |

#### **`screen_probes`**
| Type   | Description                                                                                                      | Path (Example)                                                                  | Schema / Format                                                                                                                                                                                                                                                           |
| ------ | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**  | The raw candidate probes generated by `get_candidates`.                                                          | `results/probegen/output/ENST..._crawled.parquet`                            | **Parquet**: As described in the `get_candidates` output.                                                                                                                                                                                                   |
| **Output** | A Parquet file for each transcript containing the best, non-overlapping probes after stricter screening.    | `results/probegen/output/ENST..._screened.parquet`                           | **Parquet**: Same schema as `_crawled.parquet`, but with a filtered set of rows.                                                                                                                                                                                          |
| **Output** | A CSV file summarizing the number of offtarget hits for each probe set against other genes.                   | `results/probegen/output/ENST..._offtarget_counts.csv`                       | **CSV**: Table with columns `gene` (string) and `count` (int).                                                                                                                                                                                                            |

#### **`construct_final_probes`**
| Type   | Description                                                                                                      | Path (Example)                                                                  | Schema / Format                                                                                                                                                                                                                                                           |
| ------ | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**  | The screened, non-overlapping probes from the `screen_probes` step.                                              | `results/probegen/output/ENST..._screened.parquet`                           | **Parquet**: As described in the `screen_probes` output.                                                                                                                                                                                                    |
| **Input**  | The codebook mapping transcripts to readout sequences.                                                           | `results/codebooks/n20_on4.json`                                                | **JSON**: As described in the `config.yaml` section.                                                                                                                                                                                                                        |
| **Output** | A Parquet file for each transcript containing the final, complete oligo sequences ready for synthesis.      | `results/probegen/output/ENST..._final_..._.parquet`                            | **Parquet**: An extension of the `_screened.parquet` schema, with additional columns like `final_construct` (string), `readout_A` (string), and `readout_B` (string), representing the full oligo sequence with primers and readout sequences attached. |



### 3. `assemble_manifest`

This final rule aggregates the probe information from all the individual `_final_..._.parquet` files into two master CSV files suitable for ordering.

| Type   | Description                                                                                                      | Path (Example)                                    | Schema / Format                                                                                                                                                                                               |
| ------ | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Input**  | All the final probe Parquet files generated in the previous step (one per transcript).                             | `results/probegen/output/ENST..._final_..._.parquet` | **Parquet**: As described above.                                                                                                                                                                                |
| **Output** | A simple manifest for internal record-keeping.                                                                   | `results/probegen/manifest.csv`                   | **CSV**: A table with columns `gene` and `final_construct`.                                                                                                                                                   |
| **Output** | A manifest formatted specifically for ordering from IDT (Integrated DNA Technologies).                           | `results/probegen/for_idt.csv`                    | **CSV**: A table with columns `Name` (e.g., Gene_Probe1), `Sequence` (the full oligo), `Scale` (e.g., 25nm), and `Purification` (e.g., STD).                                                                  | 